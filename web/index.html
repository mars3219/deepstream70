<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC Video</title>
</head>
<body>
    <h1>WebRTC Video Stream</h1>
    <video id="remoteVideo" autoplay playsinline></video>

    <script>
        const signalingServerUrl = 'ws://localhost:8765';  // Signaling 서버 URL
        let peerConnection;
        let localStream;

        const remoteVideo = document.getElementById('remoteVideo');

        // WebSocket 연결
        const socket = new WebSocket(signalingServerUrl);

        socket.onopen = () => {
            console.log('WebSocket connected');
        };

        socket.onmessage = async (event) => {
            const message = JSON.parse(event.data);

            switch (message.type) {
                case 'offer':
                    console.log('Received offer');
                    await handleOffer(message);
                    break;
                case 'answer':
                    console.log('Received answer');
                    await handleAnswer(message);
                    break;
                case 'candidate':
                    console.log('Received candidate');
                    await handleCandidate(message);
                    break;
            }
        };

        // WebRTC 연결을 위한 offer 처리
        async function handleOffer(message) {
            const offerSdp = new RTCSessionDescription({ type: 'offer', sdp: message.sdp });

            peerConnection = new RTCPeerConnection();

            // 비디오 스트림을 표시하기 위한 비디오 요소 설정
            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            // offer로부터 connection 설정
            await peerConnection.setRemoteDescription(offerSdp);

            // answer 생성
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            // WebSocket을 통해 answer 전송
            const answerMsg = {
                type: 'answer',
                sdp: answer.sdp
            };
            socket.send(JSON.stringify(answerMsg));
        }

        // answer 처리
        async function handleAnswer(message) {
            const answerSdp = new RTCSessionDescription({ type: 'answer', sdp: message.sdp });
            await peerConnection.setRemoteDescription(answerSdp);
        }

        // ICE candidate 처리
        async function handleCandidate(message) {
            const candidate = new RTCIceCandidate(message.candidate);
            await peerConnection.addIceCandidate(candidate);
        }

        // WebRTC 연결 설정 후 signaling 서버로 candidate 전송
        peerConnection.onicecandidate = (event) => {
            if (event.candidate) {
                const candidateMsg = {
                    type: 'candidate',
                    candidate: event.candidate
                };
                socket.send(JSON.stringify(candidateMsg));
            }
        };
    </script>
</body>
</html>
